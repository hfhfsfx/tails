-- 维度融合 - 自动锁定最近玩家脚本
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- 动态获取当前玩家（换号自动适配，无硬编码）
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local RootPart = Character:WaitForChild("HumanoidRootPart")

-- 核心变量（开关+目标）
local isEnabled = false  -- 初始关闭
local targetPlayer = nil -- 当前锁定的目标


-- 1. 角色加载监听（重生后自动重新绑定）
LocalPlayer.CharacterAdded:Connect(function(newChar)
    Character = newChar
    Humanoid = Character:WaitForChild("Humanoid")
    RootPart = Character:WaitForChild("HumanoidRootPart")
end)


-- 2. K键开关逻辑（按K切换开/关）
UIS.InputBegan:Connect(function(input, isGameProcessed)
    -- 只响应非输入框的K键按下
    if isGameProcessed then return end
    if input.KeyCode == Enum.KeyCode.K then
        isEnabled = not isEnabled -- 切换状态
        print(isEnabled and "[维度融合] 自动锁定开启" or "[维度融合] 自动锁定关闭")
        if not isEnabled then targetPlayer = nil end -- 关闭时清空目标
    end
end)


-- 3. 实时找最近的玩家（每帧检测）
local function findNearestPlayer()
    local nearestDist = math.huge -- 初始最大距离
    local nearest = nil

    for _, player in ipairs(Players:GetPlayers()) do
        -- 排除自己+玩家角色存在+玩家存活
        if player ~= LocalPlayer 
           and player.Character 
           and player.Character:FindFirstChild("Humanoid") 
           and player.Character.Humanoid.Health > 0 
           and player.Character:FindFirstChild("HumanoidRootPart") then
            
            local targetRoot = player.Character.HumanoidRootPart
            local dist = (RootPart.Position - targetRoot.Position).Magnitude -- 计算距离
            
            -- 更新最近目标
            if dist < nearestDist then
                nearestDist = dist
                nearest = player
            end
        end
    end
    return nearest
end


-- 4. 自动朝向+自动走向目标（核心逻辑，每帧执行）
RunService.RenderStepped:Connect(function()
    -- 开关关闭/角色未加载/人形死亡 → 停止逻辑
    if not isEnabled or not RootPart or Humanoid.Health <= 0 then
        return
    end

    -- 找最近玩家（无目标时重新找，有目标判断是否存活）
    targetPlayer = findNearestPlayer()
    if not targetPlayer then return end

    local targetCharacter = targetPlayer.Character
    local targetRoot = targetCharacter:FindFirstChild("HumanoidRootPart")
    local targetHumanoid = targetCharacter:FindFirstChild("Humanoid")

    -- 目标死亡/消失 → 清空目标
    if not targetRoot or targetHumanoid.Health <= 0 then
        targetPlayer = nil
        return
    end


    -- ✅ 自动朝向目标（始终面朝目标，不受自身移动影响）
    local lookDir = (targetRoot.Position - RootPart.Position).Unit -- 朝向向量
    lookDir = Vector3.new(lookDir.X, 0, lookDir.Z) -- 忽略Y轴（不抬头低头，只水平转向）
    if lookDir.Magnitude > 0 then -- 防止向量为0报错
        RootPart.CFrame = CFrame.new(RootPart.Position, RootPart.Position + lookDir)
    end


    -- ✅ 自动走向目标（持续往目标方向移动，不卡顿）
    Humanoid:MoveTo(targetRoot.Position)
    -- 目标移动时补全移动指令，避免断走
    Humanoid.MoveToFinished:Connect(function(reached)
        if isEnabled and targetPlayer and targetRoot then
            Humanoid:MoveTo(targetRoot.Position)
        end
    end)
end)
