-- 维度融合 - 自动锁定+强制走向目标（修复版）
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- 动态适配玩家（换号直接用）
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local RootPart = Character:WaitForChild("HumanoidRootPart")

-- 核心开关+目标
local isEnabled = false  -- 初始关闭
local targetPlayer = nil


-- 1. 重生自动重绑（防失效）
LocalPlayer.CharacterAdded:Connect(function(newChar)
    Character = newChar
    Humanoid = Character:WaitForChild("Humanoid")
    RootPart = Character:WaitForChild("HumanoidRootPart")
end)


-- 2. K键开关（按K切开关）
UIS.InputBegan:Connect(function(input, isGameProcessed)
    if isGameProcessed then return end
    if input.KeyCode == Enum.KeyCode.K then
        isEnabled = not isEnabled
        print(isEnabled and "[维度融合] 自动锁定+走向开启" or "[维度融合] 自动锁定+走向关闭")
        targetPlayer = isEnabled and findNearestPlayer() or nil -- 开启直接找目标，关闭清目标
    end
end)


-- 3. 找最近存活玩家（优先锁最近）
local function findNearestPlayer()
    local nearestDist = math.huge
    local nearest = nil
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer 
           and player.Character 
           and player.Character:FindFirstChild("Humanoid") 
           and player.Character.Humanoid.Health > 0 
           and player.Character:FindFirstChild("HumanoidRootPart") then
            
            local targetRoot = player.Character.HumanoidRootPart
            local dist = (RootPart.Position - targetRoot.Position).Magnitude
            if dist < nearestDist then
                nearestDist = dist
                nearest = player
            end
        end
    end
    return nearest
end


-- 4. 核心修复：强制朝向+强制走向（每帧生效，不被打断）
RunService.RenderStepped:Connect(function()
    -- 开关关/角色没加载/死了 → 不执行
    if not isEnabled or not RootPart or not Humanoid or Humanoid.Health <= 0 then
        return
    end

    -- 实时更新最近目标（目标死了/消失就重找）
    targetPlayer = findNearestPlayer()
    if not targetPlayer then return end

    local targetRoot = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
    local targetHumanoid = targetPlayer.Character:FindFirstChild("Humanoid")
    if not targetRoot or targetHumanoid.Health <= 0 then
        targetPlayer = nil
        return
    end


    -- ✅ 强制朝向目标（水平转向，不抬头低头）
    local lookDir = (targetRoot.Position - RootPart.Position).Unit
    lookDir = Vector3.new(lookDir.X, 0, lookDir.Z) -- 锁定Y=0，只转左右
    if lookDir.Magnitude > 0 then
        RootPart.CFrame = CFrame.new(RootPart.Position, RootPart.Position + lookDir)
    end


    -- ✅ 强制走向目标（修复核心！用MoveVector赋值，不被手动移动打断）
    local moveDir = lookDir -- 移动方向=朝向方向
    Humanoid:Move(moveDir, true) -- 第二个参数=true → 忽略玩家手动输入，强制移动
end)
