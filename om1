-- 自动朝向最近玩家（K键开关）- 适配Dimensional Coalescence
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- 动态获取本地玩家+角色（换号也能用，无需改代码）
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
local Humanoid = Character:WaitForChild("Humanoid")

-- 开关状态+最近玩家缓存
local isEnabled = false  -- 默认关闭
local targetPlayer = nil

-- 角色重生时重新绑定部件（防止死了失效）
LocalPlayer.CharacterAdded:Connect(function(newChar)
    Character = newChar
    HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
    Humanoid = Character:WaitForChild("Humanoid")
end)

-- 按K键切换开关
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end  -- 忽略聊天/UI输入时按K
    if input.KeyCode == Enum.KeyCode.K then
        isEnabled = not isEnabled  -- 切换开启/关闭
        print("自动朝向功能：" .. (isEnabled and "已开启" or "已关闭"))  -- 控制台提示（可选删除）
    end
end)

-- 实时计算最近玩家+自动转向（每帧更新，流畅不卡顿）
RunService.RenderStepped:Connect(function()
    -- 关闭状态/角色死亡/没根部件 → 不执行
    if not isEnabled or Humanoid.Health <= 0 or not HumanoidRootPart then
        targetPlayer = nil
        return
    end

    local closestDistance = math.huge  -- 初始设为无限远
    targetPlayer = nil

    -- 遍历所有玩家，找最近的（排除自己）
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local targetChar = player.Character
            local targetRoot = targetChar and targetChar:FindFirstChild("HumanoidRootPart")
            local targetHumanoid = targetChar and targetChar:FindFirstChild("Humanoid")
            
            -- 目标必须存活+有根部件才生效
            if targetRoot and targetHumanoid and targetHumanoid.Health > 0 then
                local distance = (HumanoidRootPart.Position - targetRoot.Position).Magnitude
                -- 更新最近玩家
                if distance < closestDistance then
                    closestDistance = distance
                    targetPlayer = targetRoot
                end
            end
        end
    end

    -- 有最近玩家 → 朝向目标（只转Y轴，不改变高度，不影响跳跃移动）
    if targetPlayer then
        local lookDirection = (targetPlayer.Position - HumanoidRootPart.Position).Unit
        lookDirection = Vector3.new(lookDirection.X, 0, lookDirection.Z)  -- 锁定Y轴，防止抬头低头
        HumanoidRootPart.CFrame = CFrame.new(HumanoidRootPart.Position, HumanoidRootPart.Position + lookDirection)
    end
end)
