local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")

-- 获取玩家角色
local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")
local humanoid = char:WaitForChild("Humanoid")

-- ==== 速度变量（共享）====
_G.WalkSpeed = 14      -- 使用全局变量或共享表
_G.RunSpeed = 26.5   
_G.CurrentSpeed = _G.WalkSpeed
local running = false

-- ==== 创建GUI ====
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SpeedControlGUI"
screenGui.Parent = player:WaitForChild("PlayerGui")

-- 主框架
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 250, 0, 200)
mainFrame.Position = UDim2.new(0, 20, 0.5, -100)
mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
mainFrame.BorderSizePixel = 0
mainFrame.BackgroundTransparency = 0.2
mainFrame.Name = "SpeedControlFrame"
mainFrame.Parent = screenGui

-- 标题
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 40)
title.Position = UDim2.new(0, 0, 0, 0)
title.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
title.Text = "速度控制器"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextSize = 20
title.Font = Enum.Font.GothamBold
title.Parent = mainFrame

-- 步行速度滑块
local walkSpeedLabel = Instance.new("TextLabel")
walkSpeedLabel.Size = UDim2.new(1, -20, 0, 25)
walkSpeedLabel.Position = UDim2.new(0, 10, 0, 50)
walkSpeedLabel.BackgroundTransparency = 1
walkSpeedLabel.Text = "步行速度: " .. _G.WalkSpeed
walkSpeedLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
walkSpeedLabel.TextSize = 16
walkSpeedLabel.TextXAlignment = Enum.TextXAlignment.Left
walkSpeedLabel.Font = Enum.Font.Gotham
walkSpeedLabel.Parent = mainFrame

local walkSpeedSlider = Instance.new("Frame")
walkSpeedSlider.Size = UDim2.new(1, -20, 0, 10)
walkSpeedSlider.Position = UDim2.new(0, 10, 0, 75)
walkSpeedSlider.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
walkSpeedSlider.BorderSizePixel = 0
walkSpeedSlider.Name = "WalkSpeedSlider"
walkSpeedSlider.Parent = mainFrame

local walkSpeedFill = Instance.new("Frame")
walkSpeedFill.Size = UDim2.new((_G.WalkSpeed - 10) / 40, 0, 1, 0)
walkSpeedFill.Position = UDim2.new(0, 0, 0, 0)
walkSpeedFill.BackgroundColor3 = Color3.fromRGB(100, 200, 255)
walkSpeedFill.BorderSizePixel = 0
walkSpeedFill.Parent = walkSpeedSlider

local walkSpeedButton = Instance.new("TextButton")
walkSpeedButton.Size = UDim2.new(0, 20, 0, 20)
walkSpeedButton.Position = UDim2.new((_G.WalkSpeed - 10) / 40, -10, 0.5, -10)
walkSpeedButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
walkSpeedButton.Text = ""
walkSpeedButton.ZIndex = 2
walkSpeedButton.Parent = walkSpeedSlider

-- 跑步速度滑块
local runSpeedLabel = Instance.new("TextLabel")
runSpeedLabel.Size = UDim2.new(1, -20, 0, 25)
runSpeedLabel.Position = UDim2.new(0, 10, 0, 95)
runSpeedLabel.BackgroundTransparency = 1
runSpeedLabel.Text = "跑步速度: " .. _G.RunSpeed
runSpeedLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
runSpeedLabel.TextSize = 16
runSpeedLabel.TextXAlignment = Enum.TextXAlignment.Left
runSpeedLabel.Font = Enum.Font.Gotham
runSpeedLabel.Parent = mainFrame

local runSpeedSlider = Instance.new("Frame")
runSpeedSlider.Size = UDim2.new(1, -20, 0, 10)
runSpeedSlider.Position = UDim2.new(0, 10, 0, 120)
runSpeedSlider.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
runSpeedSlider.BorderSizePixel = 0
runSpeedSlider.Name = "RunSpeedSlider"
runSpeedSlider.Parent = mainFrame

local runSpeedFill = Instance.new("Frame")
runSpeedFill.Size = UDim2.new((_G.RunSpeed - 10) / 40, 0, 1, 0)
runSpeedFill.Position = UDim2.new(0, 0, 0, 0)
runSpeedFill.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
runSpeedFill.BorderSizePixel = 0
runSpeedFill.Name = "RunSpeedFill"
runSpeedFill.Parent = runSpeedSlider

local runSpeedButton = Instance.new("TextButton")
runSpeedButton.Size = UDim2.new(0, 20, 0, 20)
runSpeedButton.Position = UDim2.new((_G.RunSpeed - 10) / 40, -10, 0.5, -10)
runSpeedButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
runSpeedButton.Text = ""
runSpeedButton.ZIndex = 2
runSpeedButton.Parent = runSpeedSlider

-- 当前速度显示
local currentSpeedLabel = Instance.new("TextLabel")
currentSpeedLabel.Size = UDim2.new(1, -20, 0, 30)
currentSpeedLabel.Position = UDim2.new(0, 10, 0, 140)
currentSpeedLabel.BackgroundTransparency = 1
currentSpeedLabel.Text = "当前速度: " .. _G.CurrentSpeed
currentSpeedLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
currentSpeedLabel.TextSize = 18
currentSpeedLabel.Font = Enum.Font.GothamBold
currentSpeedLabel.Parent = mainFrame

-- 状态显示
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, -20, 0, 20)
statusLabel.Position = UDim2.new(0, 10, 0, 170)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "状态: 步行"
statusLabel.TextColor3 = Color3.fromRGB(150, 255, 150)
statusLabel.TextSize = 14
statusLabel.Font = Enum.Font.Gotham
statusLabel.Parent = mainFrame

-- 滑块更新函数
local function updateWalkSpeed(value)
    _G.WalkSpeed = value
    walkSpeedLabel.Text = "步行速度: " .. _G.WalkSpeed
    if not running then
        _G.CurrentSpeed = _G.WalkSpeed
        currentSpeedLabel.Text = "当前速度: " .. _G.CurrentSpeed
    end
end

local function updateRunSpeed(value)
    _G.RunSpeed = value
    runSpeedLabel.Text = "跑步速度: " .. _G.RunSpeed
    if running then
        _G.CurrentSpeed = _G.RunSpeed
        currentSpeedLabel.Text = "当前速度: " .. _G.CurrentSpeed
    end
end

-- 滑块拖动逻辑
local function setupSlider(sliderFrame, fillFrame, button, label, isRunSlider)
    local draggingSlider = false
    
    button.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            draggingSlider = true
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if draggingSlider and input.UserInputType == Enum.UserInputType.MouseMovement then
            local sliderAbsolutePosition = sliderFrame.AbsolutePosition
            local sliderAbsoluteSize = sliderFrame.AbsoluteSize
            local mouseX = input.Position.X
            
            local relativeX = (mouseX - sliderAbsolutePosition.X) / sliderAbsoluteSize.X
            relativeX = math.clamp(relativeX, 0, 1)
            
            local speedValue = math.floor(10 + relativeX * 40)
            
            button.Position = UDim2.new(relativeX, -10, 0.5, -10)
            fillFrame.Size = UDim2.new(relativeX, 0, 1, 0)
            
            if isRunSlider then
                updateRunSpeed(speedValue)
            else
                updateWalkSpeed(speedValue)
            end
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            draggingSlider = false
        end
    end)
    
    sliderFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            local sliderAbsolutePosition = sliderFrame.AbsolutePosition
            local sliderAbsoluteSize = sliderFrame.AbsoluteSize
            local mouseX = input.Position.X
            
            local relativeX = (mouseX - sliderAbsolutePosition.X) / sliderAbsoluteSize.X
            relativeX = math.clamp(relativeX, 0, 1)
            
            local speedValue = math.floor(relativeX * 50)
            
            button.Position = UDim2.new(relativeX, -10, 0.5, -10)
            fillFrame.Size = UDim2.new(relativeX, 0, 1, 0)
            
            if isRunSlider then
                updateRunSpeed(speedValue)
            else
                updateWalkSpeed(speedValue)
            end
        end
    end)
end

-- 设置滑块
setupSlider(walkSpeedSlider, walkSpeedFill, walkSpeedButton, walkSpeedLabel, false)
setupSlider(runSpeedSlider, runSpeedFill, runSpeedButton, runSpeedLabel, true)

-- ==== 移动逻辑（使用_G中的变量）====
UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == Enum.KeyCode.LeftShift then
        running = true
        _G.CurrentSpeed = _G.RunSpeed
        currentSpeedLabel.Text = "当前速度: " .. _G.CurrentSpeed
        statusLabel.Text = "状态: 跑步"
        statusLabel.TextColor3 = Color3.fromRGB(255, 150, 150)
    end
end)

UserInputService.InputEnded:Connect(function(input, gpe)
    if input.KeyCode == Enum.KeyCode.LeftShift then
        running = false
        _G.CurrentSpeed = _G.WalkSpeed
        currentSpeedLabel.Text = "当前速度: " .. _G.CurrentSpeed
        statusLabel.Text = "状态: 步行"
        statusLabel.TextColor3 = Color3.fromRGB(150, 255, 150)
    end
end)

RunService.RenderStepped:Connect(function(dt)
    local moveDir = humanoid.MoveDirection
    if moveDir.Magnitude > 0 then
        -- 关键：使用 _G.CurrentSpeed 而不是局部变量
        hrp.CFrame = hrp.CFrame + (moveDir * _G.CurrentSpeed * dt)
    end
end)
