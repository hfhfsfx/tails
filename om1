-- 自动朝向最近玩家脚本（鼠标右键切换版）- 完全锁定视角
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera

-- 配置
local config = {
    enabled = false,  -- 默认关闭
    toggleButton = Enum.UserInputType.MouseButton2,  -- 鼠标右键
    updateInterval = 0.1,  -- 更新间隔(秒)
    maxDistance = 100,  -- 最大检测距离
    includeSelf = false,  -- 是否包括自己
    smoothRotation = true,  -- 平滑旋转
    rotationSpeed = 5,  -- 旋转速度
    alwaysForward = true,  -- 开启时所有方向键都向面朝方向移动
    lockCamera = true  -- 锁定摄像机视角
}

-- 显示状态提示
local function showNotification(message, color)
    print("[自动锁定] " .. message)
    
    -- 可选：在屏幕上显示提示
    local ScreenGui = LocalPlayer:WaitForChild("PlayerGui"):FindFirstChild("AutoLookNotification")
    if not ScreenGui then
        ScreenGui = Instance.new("ScreenGui")
        ScreenGui.Name = "AutoLookNotification"
        ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    end
    
    -- 清除旧的通知
    for _, child in ipairs(ScreenGui:GetChildren()) do
        child:Destroy()
    end
    
    -- 创建新通知
    local Frame = Instance.new("Frame")
    Frame.Size = UDim2.new(0, 300, 0, 50)
    Frame.Position = UDim2.new(0.5, -150, 0.05, 0)
    Frame.BackgroundColor3 = color or Color3.fromRGB(30, 30, 30)
    Frame.BackgroundTransparency = 0.3
    Frame.BorderSizePixel = 0
    
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 8)
    UICorner.Parent = Frame
    
    local TextLabel = Instance.new("TextLabel")
    TextLabel.Text = message
    TextLabel.Size = UDim2.new(1, 0, 1, 0)
    TextLabel.BackgroundTransparency = 1
    TextLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    TextLabel.TextScaled = true
    TextLabel.Font = Enum.Font.GothamBold
    TextLabel.Parent = Frame
    
    Frame.Parent = ScreenGui
    
    -- 3秒后自动消失
    task.delay(3, function()
        if Frame and Frame.Parent then
            Frame:Destroy()
        end
    end)
end

-- 获取最近玩家的函数
local function getNearestPlayer()
    local character = LocalPlayer.Character
    if not character then return nil end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return nil end
    
    local nearestPlayer = nil
    local nearestDistance = math.huge
    
    for _, player in ipairs(Players:GetPlayers()) do
        -- 跳过自己（如果配置为不包括自己）
        if config.includeSelf or player ~= LocalPlayer then
            local targetCharacter = player.Character
            if targetCharacter then
                local targetRoot = targetCharacter:FindFirstChild("HumanoidRootPart")
                if targetRoot then
                    local distance = (humanoidRootPart.Position - targetRoot.Position).Magnitude
                    
                    -- 检查距离是否在范围内
                    if distance < config.maxDistance and distance < nearestDistance then
                        nearestDistance = distance
                        nearestPlayer = player
                    end
                end
            end
        end
    end
    
    return nearestPlayer, nearestDistance
end

-- 获取目标位置（考虑头部或胸部）
local function getTargetPosition(character)
    -- 先尝试获取头部位置
    local head = character:FindFirstChild("Head")
    if head then
        return head.Position
    end
    
    -- 没有头部则获取上半身位置
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if humanoidRootPart then
        return humanoidRootPart.Position + Vector3.new(0, 2, 0)  -- 假设角色高度约2米
    end
    
    -- 如果都没有，返回角色位置
    return character:GetPivot().Position
end

-- 计算从摄像机到目标的完整方向（包括垂直和水平）
local function getFullLookDirection(startPos, targetPos)
    local diff = targetPos - startPos
    
    -- 检查向量长度是否为0（避免除以0）
    if diff.Magnitude == 0 then
        return Vector3.new(0, 0, 1)  -- 默认向前看
    end
    
    return diff.Unit
end

-- 获取角色的面朝方向向量（完整，包括垂直）
local function getCharacterFullLookDirection()
    local character = LocalPlayer.Character
    if not character then return Vector3.new(0, 0, 1) end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return Vector3.new(0, 0, 1) end
    
    return humanoidRootPart.CFrame.LookVector
end

-- 跟踪按键状态
local pressedKeys = {}
local isMoving = false

-- 检查是否在移动按键中
local function isMovementKey(keyCode)
    local movementKeys = {
        Enum.KeyCode.W, Enum.KeyCode.A, Enum.KeyCode.S, Enum.KeyCode.D,
        Enum.KeyCode.Up, Enum.KeyCode.Down, Enum.KeyCode.Left, Enum.KeyCode.Right
    }
    
    for _, movementKey in ipairs(movementKeys) do
        if keyCode == movementKey then
            return true
        end
    end
    return false
end

-- 检查是否有移动按键被按下
local function anyMovementKeyPressed()
    local movementKeys = {
        Enum.KeyCode.W, Enum.KeyCode.A, Enum.KeyCode.S, Enum.KeyCode.D,
        Enum.KeyCode.Up, Enum.KeyCode.Down, Enum.KeyCode.Left, Enum.KeyCode.Right
    }
    
    for _, keyCode in ipairs(movementKeys) do
        if pressedKeys[keyCode] then
            return true
        end
    end
    return false
end

-- 完全锁定视角（角色朝向 + 摄像机视角）
local function lockViewToTarget()
    if not config.enabled then return end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    local nearestPlayer, distance = getNearestPlayer()
    if not nearestPlayer then return end
    
    local targetCharacter = nearestPlayer.Character
    if not targetCharacter then return end
    
    local targetPos = getTargetPosition(targetCharacter)
    
    -- 1. 锁定角色朝向（仅水平）
    local horizontalDiff = Vector3.new(
        targetPos.X - humanoidRootPart.Position.X,
        0,
        targetPos.Z - humanoidRootPart.Position.Z
    )
    
    if horizontalDiff.Magnitude > 0 then
        local horizontalDirection = horizontalDiff.Unit
        
        if config.smoothRotation then
            -- 平滑旋转角色
            local currentCFrame = humanoidRootPart.CFrame
            local targetCFrame = CFrame.new(humanoidRootPart.Position, humanoidRootPart.Position + horizontalDirection)
            local newCFrame = currentCFrame:Lerp(targetCFrame, config.rotationSpeed * config.updateInterval)
            humanoidRootPart.CFrame = newCFrame
        else
            -- 直接朝向
            humanoidRootPart.CFrame = CFrame.new(humanoidRootPart.Position, humanoidRootPart.Position + horizontalDirection)
        end
    end
    
    -- 2. 锁定摄像机视角（完整方向，包括垂直）
    if config.lockCamera and Camera then
        local cameraPos = Camera.CFrame.Position
        local cameraToTarget = getFullLookDirection(cameraPos, targetPos)
        
        -- 创建新的摄像机CFrame，完全看向目标
        local newCameraCFrame = CFrame.new(cameraPos, cameraPos + cameraToTarget)
        
        if config.smoothRotation then
            -- 平滑旋转摄像机
            local currentCameraCFrame = Camera.CFrame
            Camera.CFrame = currentCameraCFrame:Lerp(newCameraCFrame, config.rotationSpeed * config.updateInterval)
        else
            -- 直接设置摄像机
            Camera.CFrame = newCameraCFrame
        end
    end
end

-- 处理按键按下
local function onInputBegan(input, gameProcessed)
    if gameProcessed or not config.enabled or not config.alwaysForward then return end
    
    if input.UserInputType == Enum.UserInputType.Keyboard then
        local keyCode = input.KeyCode
        if isMovementKey(keyCode) then
            pressedKeys[keyCode] = true
            isMoving = true
        end
    end
end

-- 处理按键释放
local function onInputEnded(input, gameProcessed)
    if gameProcessed then return end
    
    if input.UserInputType == Enum.UserInputType.Keyboard then
        local keyCode = input.KeyCode
        if isMovementKey(keyCode) then
            pressedKeys[keyCode] = nil
            
            -- 检查是否还有移动按键被按下
            if not anyMovementKeyPressed() then
                isMoving = false
                
                -- 停止移动
                local character = LocalPlayer.Character
                if character then
                    local humanoid = character:FindFirstChild("Humanoid")
                    if humanoid then
                        humanoid:Move(Vector3.new(0, 0, 0), false)
                    end
                end
            end
        end
    end
end

-- 持续移动
local function updateMovement()
    if not config.enabled or not config.alwaysForward then
        return
    end
    
    if not isMoving then
        return
    end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    -- 获取角色的面朝方向（水平）
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    local lookVector = humanoidRootPart.CFrame.LookVector
    local lookDirection = Vector3.new(lookVector.X, 0, lookVector.Z).Unit
    
    -- 向前移动
    humanoid:Move(lookDirection, true)
end

-- 主循环
local lockConnection = nil
local moveConnection = nil

local function startAutoLook()
    if lockConnection then return end
    
    -- 开启完全锁定循环（角色 + 摄像机）
    lockConnection = RunService.Heartbeat:Connect(function(deltaTime)
        lockViewToTarget()
    end)
    
    -- 开启移动循环
    moveConnection = RunService.Heartbeat:Connect(function(deltaTime)
        updateMovement()
    end)
    
    -- 绑定输入监听
    UserInputService.InputBegan:Connect(onInputBegan)
    UserInputService.InputEnded:Connect(onInputEnded)
    
    -- 禁用鼠标转动视角
    if config.lockCamera then
        local playerScripts = LocalPlayer:WaitForChild("PlayerScripts")
        local playerModule = require(playerScripts:WaitForChild("PlayerModule"))
        local controls = playerModule:GetControls()
        
        -- 禁用鼠标视角控制
        if controls then
            controls:Disable()
        end
    end
    
    showNotification("视角完全锁定已开启\n摄像机强制锁定目标", Color3.fromRGB(0, 200, 255))
end

local function stopAutoLook()
    if lockConnection then
        lockConnection:Disconnect()
        lockConnection = nil
    end
    
    if moveConnection then
        moveConnection:Disconnect()
        moveConnection = nil
    end
    
    -- 停止移动
    isMoving = false
    
    -- 清除按键状态
    pressedKeys = {}
    
    -- 确保角色停止移动
    local character = LocalPlayer.Character
    if character then
        local humanoid = character:FindFirstChild("Humanoid")
        if humanoid then
            humanoid:Move(Vector3.new(0, 0, 0), false)
        end
    end
    
    -- 恢复鼠标控制
    if config.lockCamera then
        local playerScripts = LocalPlayer:WaitForChild("PlayerScripts")
        local playerModule = require(playerScripts:WaitForChild("PlayerModule"))
        local controls = playerModule:GetControls()
        
        -- 启用鼠标视角控制
        if controls then
            controls:Enable()
        end
    end
    
    showNotification("视角锁定已关闭\n恢复自由视角", Color3.fromRGB(255, 50, 50))
end

-- 鼠标右键绑定
local mouseButtonConnection = nil

local function setupMouseButton()
    if mouseButtonConnection then
        mouseButtonConnection:Disconnect()
    end
    
    mouseButtonConnection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        
        -- 检查是否是鼠标右键
        if input.UserInputType == config.toggleButton then
            config.enabled = not config.enabled
            
            if config.enabled then
                startAutoLook()
            else
                stopAutoLook()
            end
        end
    end)
end

-- 初始化鼠标绑定
setupMouseButton()

-- 角色死亡时重置
LocalPlayer.CharacterAdded:Connect(function(character)
    -- 等待角色加载
    task.wait(1)
    
    -- 重置移动状态
    isMoving = false
    pressedKeys = {}
    
    -- 如果功能启用，重新启动
    if config.enabled then
        if lockConnection then
            lockConnection:Disconnect()
            lockConnection = nil
        end
        if moveConnection then
            moveConnection:Disconnect()
            moveConnection = nil
        end
        startAutoLook()
    end
end)

LocalPlayer.CharacterRemoving:Connect(function()
    if lockConnection then
        lockConnection:Disconnect()
        lockConnection = nil
    end
    if moveConnection then
        moveConnection:Disconnect()
        moveConnection = nil
    end
    
    -- 重置移动状态
    isMoving = false
    pressedKeys = {}
end)

-- 创建常驻状态显示
local function createStatusDisplay()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "AutoLookStatus"
    ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    
    local Frame = Instance.new("Frame")
    Frame.Size = UDim2.new(0, 250, 0, 70)
    Frame.Position = UDim2.new(0.02, 0, 0.95, -70)
    Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    Frame.BackgroundTransparency = 0.5
    Frame.BorderSizePixel = 0
    Frame.Parent = ScreenGui
    
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 8)
    UICorner.Parent = Frame
    
    local StatusLabel = Instance.new("TextLabel")
    StatusLabel.Name = "StatusLabel"
    StatusLabel.Text = "视角锁定: 关闭"
    StatusLabel.Size = UDim2.new(1, 0, 0.33, 0)
    StatusLabel.BackgroundTransparency = 1
    StatusLabel.TextColor3 = Color3.fromRGB(255, 50, 50)
    StatusLabel.TextScaled = true
    StatusLabel.Font = Enum.Font.GothamBold
    StatusLabel.TextStrokeTransparency = 0.5
    StatusLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    StatusLabel.Parent = Frame
    
    local CameraLabel = Instance.new("TextLabel")
    CameraLabel.Name = "CameraLabel"
    CameraLabel.Text = "摄像机: 自由"
    CameraLabel.Size = UDim2.new(1, 0, 0.33, 0)
    CameraLabel.Position = UDim2.new(0, 0, 0.33, 0)
    CameraLabel.BackgroundTransparency = 1
    CameraLabel.TextColor3 = Color3.fromRGB(150, 200, 255)
    CameraLabel.TextScaled = true
    CameraLabel.Font = Enum.Font.GothamMedium
    CameraLabel.Parent = Frame
    
    local MovementLabel = Instance.new("TextLabel")
    MovementLabel.Name = "MovementLabel"
    MovementLabel.Text = "移动: 方向键 -> 向前"
    MovementLabel.Size = UDim2.new(1, 0, 0.33, 0)
    MovementLabel.Position = UDim2.new(0, 0, 0.66, 0)
    MovementLabel.BackgroundTransparency = 1
    MovementLabel.TextColor3 = Color3.fromRGB(150, 200, 255)
    MovementLabel.TextScaled = true
    MovementLabel.Font = Enum.Font.GothamMedium
    MovementLabel.Parent = Frame
    
    -- 更新状态显示
    local function updateStatusDisplay()
        if config.enabled then
            StatusLabel.Text = "视角锁定: 开启"
            StatusLabel.TextColor3 = Color3.fromRGB(0, 255, 100)
            
            if config.lockCamera then
                CameraLabel.Text = "摄像机: 锁定"
                CameraLabel.TextColor3 = Color3.fromRGB(0, 200, 255)
            else
                CameraLabel.Text = "摄像机: 自由"
                CameraLabel.TextColor3 = Color3.fromRGB(150, 200, 255)
            end
            
            if config.alwaysForward then
                MovementLabel.Text = "移动: 方向键 -> 向前"
                MovementLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
            else
                MovementLabel.Text = "移动: 默认"
                MovementLabel.TextColor3 = Color3.fromRGB(150, 200, 255)
            end
        else
            StatusLabel.Text = "视角锁定: 关闭"
            StatusLabel.TextColor3 = Color3.fromRGB(255, 50, 50)
            CameraLabel.Text = "摄像机: 自由"
            CameraLabel.TextColor3 = Color3.fromRGB(150, 200, 255)
            MovementLabel.Text = "移动: 默认"
            MovementLabel.TextColor3 = Color3.fromRGB(150, 200, 255)
        end
    end
    
    -- 定期更新状态
    RunService.Heartbeat:Connect(function()
        updateStatusDisplay()
    end)
    
    return ScreenGui
end

-- 创建状态显示
createStatusDisplay()

-- 初始提示
showNotification("完全视角锁定脚本已加载\n右键鼠标切换开关\n开启时摄像机强制锁定目标", Color3.fromRGB(0, 200, 255))

print("[完全视角锁定] 脚本已加载")
print("[完全视角锁定] 鼠标右键切换开关")
print("[完全视角锁定] 开启时: 角色朝向锁定 + 摄像机视角锁定")
print("[完全视角锁定] 当前状态: " .. (config.enabled and "开启" or "关闭"))

-- 游戏关闭时清理
game:BindToClose(function()
    stopAutoLook()
end)
