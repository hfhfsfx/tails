-- 自动朝向最近玩家脚本（修复版）
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

-- 配置
local config = {
    enabled = false,
    toggleKey = "K",
    updateInterval = 0.1,
    maxDistance = 100,
    includeSelf = false,
    smoothRotation = true,
    rotationSpeed = 5
}

print("[调试] 脚本开始加载...")

-- 显示状态提示
local function showNotification(message, color)
    print("[状态] " .. message)
    
    -- 可选：创建屏幕提示
    local success, err = pcall(function()
        local ScreenGui = LocalPlayer:WaitForChild("PlayerGui"):FindFirstChild("AutoLookNotification")
        if not ScreenGui then
            ScreenGui = Instance.new("ScreenGui")
            ScreenGui.Name = "AutoLookNotification"
            ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
        end
        
        -- 清除旧通知
        for _, child in ipairs(ScreenGui:GetChildren()) do
            child:Destroy()
        end
        
        -- 创建新通知
        local Frame = Instance.new("Frame")
        Frame.Size = UDim2.new(0, 300, 0, 50)
        Frame.Position = UDim2.new(0.5, -150, 0.05, 0)
        Frame.BackgroundColor3 = color or Color3.fromRGB(30, 30, 30)
        Frame.BackgroundTransparency = 0.3
        Frame.BorderSizePixel = 0
        
        local UICorner = Instance.new("UICorner")
        UICorner.CornerRadius = UDim.new(0, 8)
        UICorner.Parent = Frame
        
        local TextLabel = Instance.new("TextLabel")
        TextLabel.Text = message
        TextLabel.Size = UDim2.new(1, 0, 1, 0)
        TextLabel.BackgroundTransparency = 1
        TextLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        TextLabel.TextScaled = true
        TextLabel.Font = Enum.Font.GothamBold
        TextLabel.Parent = Frame
        
        Frame.Parent = ScreenGui
        
        -- 3秒后消失
        task.delay(3, function()
            if Frame and Frame.Parent then
                Frame:Destroy()
            end
        end)
    end)
    
    if not success then
        print("[警告] 创建通知失败:", err)
    end
end

-- 获取最近玩家
local function getNearestPlayer()
    local character = LocalPlayer.Character
    if not character then 
        print("[调试] 无角色")
        return nil 
    end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then 
        print("[调试] 无HumanoidRootPart")
        return nil 
    end
    
    local nearestPlayer = nil
    local nearestDistance = math.huge
    
    for _, player in ipairs(Players:GetPlayers()) do
        if config.includeSelf or player ~= LocalPlayer then
            local targetCharacter = player.Character
            if targetCharacter then
                local targetRoot = targetCharacter:FindFirstChild("HumanoidRootPart")
                if targetRoot then
                    local distance = (humanoidRootPart.Position - targetRoot.Position).Magnitude
                    if distance < config.maxDistance and distance < nearestDistance then
                        nearestDistance = distance
                        nearestPlayer = player
                    end
                end
            end
        end
    end
    
    return nearestPlayer, nearestDistance
end

-- 朝向目标
local function lookAtTarget()
    if not config.enabled then return end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    local nearestPlayer = getNearestPlayer()
    if not nearestPlayer then return end
    
    local targetCharacter = nearestPlayer.Character
    if not targetCharacter then return end
    
    local targetRoot = targetCharacter:FindFirstChild("HumanoidRootPart")
    if not targetRoot then return end
    
    local lookDirection = (targetRoot.Position - humanoidRootPart.Position).Unit
    
    if config.smoothRotation then
        local currentCFrame = humanoidRootPart.CFrame
        local targetCFrame = CFrame.new(humanoidRootPart.Position, humanoidRootPart.Position + lookDirection)
        local newCFrame = currentCFrame:Lerp(targetCFrame, config.rotationSpeed * config.updateInterval)
        humanoidRootPart.CFrame = newCFrame
    else
        humanoidRootPart.CFrame = CFrame.new(humanoidRootPart.Position, humanoidRootPart.Position + lookDirection)
    end
end

-- 主循环
local connection = nil

local function startAutoLook()
    print("[调试] 尝试启动自动朝向...")
    
    if connection then
        print("[调试] 连接已存在，先断开")
        connection:Disconnect()
        connection = nil
    end
    
    connection = RunService.Heartbeat:Connect(function(deltaTime)
        lookAtTarget()
    end)
    
    showNotification("自动朝向已开启 (按K关闭)", Color3.fromRGB(0, 255, 0))
    print("[状态] 自动朝向已开启")
end

local function stopAutoLook()
    print("[调试] 尝试停止自动朝向...")
    
    if connection then
        connection:Disconnect()
        connection = nil
        print("[调试] 连接已断开")
    else
        print("[调试] 无活动连接")
    end
    
    showNotification("自动朝向已关闭 (按K开启)", Color3.fromRGB(255, 50, 50))
    print("[状态] 自动朝向已关闭")
end

-- 调试：手动测试函数
local function testToggle()
    print("[测试] 手动切换")
    config.enabled = not config.enabled
    print("[测试] 新状态:", config.enabled)
    
    if config.enabled then
        startAutoLook()
    else
        stopAutoLook()
    end
end

-- 按键绑定（简化版）
print("[调试] 设置按键绑定...")

local keyConnection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
    -- 调试输出
    print("[按键] 按键检测:", input.KeyCode, "游戏处理:", gameProcessed)
    
    -- 直接检测K键，不检查gameProcessed
    if input.KeyCode == Enum.KeyCode.K then
        print("[按键] K键被按下")
        
        -- 切换状态
        config.enabled = not config.enabled
        print("[状态切换] 新状态:", config.enabled)
        
        if config.enabled then
            startAutoLook()
        else
            stopAutoLook()
        end
        
        -- 阻止默认行为（可选）
        -- return Enum.ContextActionResult.Sink
    end
end)

-- 角色事件
LocalPlayer.CharacterAdded:Connect(function(character)
    print("[角色] 角色已添加")
    task.wait(1)
    
    if config.enabled then
        print("[角色] 重新启动自动朝向")
        if connection then
            connection:Disconnect()
            connection = nil
        end
        startAutoLook()
    end
end)

LocalPlayer.CharacterRemoving:Connect(function()
    print("[角色] 角色移除中")
    if connection then
        connection:Disconnect()
        connection = nil
    end
end)

-- 创建简单状态显示
local function createSimpleStatus()
    local success, err = pcall(function()
        local ScreenGui = Instance.new("ScreenGui")
        ScreenGui.Name = "SimpleAutoLookStatus"
        ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
        
        local TextLabel = Instance.new("TextLabel")
        TextLabel.Name = "StatusText"
        TextLabel.Text = "自动朝向: 关闭 (K键)"
        TextLabel.Size = UDim2.new(0, 200, 0, 30)
        TextLabel.Position = UDim2.new(0.02, 0, 0.02, 0)
        TextLabel.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        TextLabel.BackgroundTransparency = 0.5
        TextLabel.TextColor3 = Color3.fromRGB(255, 50, 50)
        TextLabel.TextScaled = true
        TextLabel.Font = Enum.Font.GothamBold
        TextLabel.Parent = ScreenGui
        
        -- 更新状态
        RunService.Heartbeat:Connect(function()
            if config.enabled then
                TextLabel.Text = "自动朝向: 开启 (K键)"
                TextLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
            else
                TextLabel.Text = "自动朝向: 关闭 (K键)"
                TextLabel.TextColor3 = Color3.fromRGB(255, 50, 50)
            end
        end)
    end)
    
    if not success then
        print("[警告] 创建状态显示失败:", err)
    end
end

-- 初始化
createSimpleStatus()
showNotification("按K键切换自动朝向", Color3.fromRGB(255, 165, 0))

print("========================================")
print("[自动朝向] 脚本加载完成")
print("[提示] 按 K 键切换开关")
print("[提示] 开启后角色会自动朝向最近玩家")
print("[提示] 查看控制台输出了解详细状态")
print("========================================")

-- 测试命令（在控制台输入）
print("[测试] 在控制台输入以下命令测试：")
print("testToggle() - 手动切换开关")
print("config.enabled = true; startAutoLook() - 强制开启")
print("config.enabled = false; stopAutoLook() - 强制关闭")
