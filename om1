-- 维度融合 - 角色+镜头双锁定目标（屏幕+身体一起跟）
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera -- 屏幕镜头

-- 动态适配玩家（换号直接用）
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local RootPart = Character:WaitForChild("HumanoidRootPart")

-- 核心变量
local isEnabled = false
local targetPlayer = nil
local cameraSmooth = 0.1 -- 镜头跟随顺滑度（越小越跟手，0.05~0.2最佳）


-- 1. 角色+镜头加载监听（重生自动续上）
LocalPlayer.CharacterAdded:Connect(function(newChar)
    Character = newChar
    Humanoid = newChar:WaitForChild("Humanoid")
    RootPart = newChar:WaitForChild("HumanoidRootPart")
    Camera.CameraSubject = Humanoid -- 重置镜头目标
end)


-- 2. K键开关（双锁同步开/关）
UIS.InputBegan:Connect(function(input, isGameProcessed)
    if isGameProcessed then return end
    if input.KeyCode == Enum.KeyCode.K then
        isEnabled = not isEnabled
        print(isEnabled and "[维度融合] 双锁定开启（角色+屏幕）" or "[维度融合] 双锁定关闭")
        targetPlayer = isEnabled and findNearestPlayer() or nil
        -- 关闭时解锁镜头，恢复正常视角
        if not isEnabled then
            Camera.CameraSubject = Humanoid
            Humanoid.AutoRotate = true
        end
    end
end)


-- 3. 找最近存活玩家（精准筛选）
local function findNearestPlayer()
    local nearestDist = math.huge
    local nearest = nil
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer 
           and player.Character 
           and player.Character:FindFirstChild("Humanoid") 
           and player.Character.Humanoid.Health > 0 
           and player.Character:FindFirstChild("HumanoidRootPart") then
            
            local targetRoot = player.Character.HumanoidRootPart
            local dist = (RootPart.Position - targetRoot.Position).Magnitude
            if dist < nearestDist then
                nearestDist = dist
                nearest = player
            end
        end
    end
    return nearest
end


-- 4. 核心双锁逻辑（角色+屏幕同步跟目标）
RunService.RenderStepped:Connect(function(deltaTime)
    if not isEnabled or not RootPart or Humanoid.Health <= 0 then return end
    targetPlayer = findNearestPlayer()
    if not targetPlayer then return end

    local targetRoot = targetPlayer.Character.HumanoidRootPart
    local targetHumanoid = targetPlayer.Character.Humanoid
    if not targetRoot or targetHumanoid.Health <= 0 then
        targetPlayer = nil
        Camera.CameraSubject = Humanoid
        return
    end


    -- ✅ 1. 屏幕镜头锁目标（跟着目标转，不丢视野）
    local cameraLookPos = Vector3.new(targetRoot.Position.X, targetRoot.Position.Y + 1, targetRoot.Position.Z) -- 镜头看目标胸口（不看脚）
    -- 顺滑跟随（不卡顿）：当前镜头位置→目标位置 渐变
    Camera.CFrame = Camera.CFrame:Lerp(
        CFrame.lookAt(Camera.CFrame.Position, cameraLookPos), -- 镜头朝向目标
        cameraSmooth -- 顺滑度（越小越快）
    )


    -- ✅ 2. 角色身体锁朝向（和屏幕同步，面朝目标）
    local charLookPos = Vector3.new(targetRoot.Position.X, RootPart.Position.Y, targetRoot.Position.Z) -- 角色水平朝目标
    RootPart.CFrame = CFrame.lookAt(RootPart.Position, charLookPos)


    -- ✅ 3. 强制朝目标移动（角色+镜头同步向前）
    local forwardDir = RootPart.CFrame.LookVector.Unit -- 角色正前方（和镜头同步）
    forwardDir = Vector3.new(forwardDir.X, 0, forwardDir.Z)
    Humanoid:Move(forwardDir, true) -- 强制移动，忽略手动输入
end)
