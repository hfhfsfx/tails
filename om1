-- 维度融合 - 强制锁目标+朝目标走（彻底修复视角干扰）
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- 动态适配玩家（换号直接用）
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local RootPart = Character:WaitForChild("HumanoidRootPart")

-- 核心变量
local isEnabled = false
local targetPlayer = nil


-- 1. 重生自动重绑（防失效）
LocalPlayer.CharacterAdded:Connect(function(newChar)
    Character = newChar
    Humanoid = newChar:WaitForChild("Humanoid")
    RootPart = newChar:WaitForChild("HumanoidRootPart")
end)


-- 2. K键开关（按K切状态）
UIS.InputBegan:Connect(function(input, isGameProcessed)
    if isGameProcessed then return end
    if input.KeyCode == Enum.KeyCode.K then
        isEnabled = not isEnabled
        print(isEnabled and "[维度融合] 强制锁定开启" or "[维度融合] 强制锁定关闭")
        targetPlayer = isEnabled and findNearestPlayer() or nil
    end
end)


-- 3. 找最近存活玩家（精准筛选）
local function findNearestPlayer()
    local nearestDist = math.huge
    local nearest = nil
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer 
           and player.Character 
           and player.Character:FindFirstChild("Humanoid") 
           and player.Character.Humanoid.Health > 0 
           and player.Character:FindFirstChild("HumanoidRootPart") then
            
            local targetRoot = player.Character.HumanoidRootPart
            local dist = (RootPart.Position - targetRoot.Position).Magnitude
            if dist < nearestDist then
                nearestDist = dist
                nearest = player
            end
        end
    end
    return nearest
end


-- 4. 终极核心：强制朝目标转向+强制朝目标移动（无视视角）
RunService.RenderStepped:Connect(function()
    if not isEnabled or not RootPart or Humanoid.Health <= 0 then return end
    targetPlayer = findNearestPlayer()
    if not targetPlayer then return end

    local targetRoot = targetPlayer.Character.HumanoidRootPart
    local targetHumanoid = targetPlayer.Character.Humanoid
    if not targetRoot or targetHumanoid.Health <= 0 then
        targetPlayer = nil
        return
    end


    -- ✅ 彻底锁朝向（无视屏幕视角，硬面朝目标）
    local targetPos = targetRoot.Position
    targetPos = Vector3.new(targetPos.X, RootPart.Position.Y, targetPos.Z) -- 强制和自身Y轴对齐，只水平转
    RootPart.CFrame = CFrame.lookAt(RootPart.Position, targetPos) -- 直接锁定朝向，不被视角干扰


    -- ✅ 强制朝目标移动（移动方向=角色面朝方向，不是屏幕方向）
    local forwardDir = RootPart.CFrame.LookVector -- 角色正前方（不是屏幕前方！）
    forwardDir = Vector3.new(forwardDir.X, 0, forwardDir.Z).Unit -- 只保留水平移动
    Humanoid:Move(forwardDir, true) -- 强制移动，忽略手动输入
end)
