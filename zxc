-- 按钮创建和传送脚本 - 传送到更高位置（可随时停止）
-- 适用于Roblox注入器

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")

-- 全局变量
local isTeleporting = false
local currentTeleportTask = nil
local baseHeight = 15

-- 创建GUI按钮
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = game.CoreGui

-- 主按钮容器
local ButtonContainer = Instance.new("Frame")
ButtonContainer.Size = UDim2.new(0, 210, 0, 120)
ButtonContainer.Position = UDim2.new(0.5, -105, 0, 20)
ButtonContainer.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
ButtonContainer.BackgroundTransparency = 0.2
ButtonContainer.Parent = ScreenGui

-- 添加容器圆角
local ContainerCorner = Instance.new("UICorner")
ContainerCorner.CornerRadius = UDim.new(0, 10)
ContainerCorner.Parent = ButtonContainer

-- 传送按钮
local TeleportButton = Instance.new("TextButton")
TeleportButton.Size = UDim2.new(0.9, 0, 0.3, 0)
TeleportButton.Position = UDim2.new(0.05, 0, 0.05, 0)
TeleportButton.Text = "开始传送到所有僵尸"
TeleportButton.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
TeleportButton.TextColor3 = Color3.fromRGB(255, 255, 255)
TeleportButton.Font = Enum.Font.GothamBold
TeleportButton.TextSize = 14
TeleportButton.Parent = ButtonContainer

-- 停止按钮
local StopButton = Instance.new("TextButton")
StopButton.Size = UDim2.new(0.9, 0, 0.3, 0)
StopButton.Position = UDim2.new(0.05, 0, 0.4, 0)
StopButton.Text = "停止传送"
StopButton.BackgroundColor3 = Color3.fromRGB(215, 60, 0)
StopButton.TextColor3 = Color3.fromRGB(255, 255, 255)
StopButton.Font = Enum.Font.GothamBold
StopButton.TextSize = 14
StopButton.Visible = false  -- 初始隐藏
StopButton.Parent = ButtonContainer

-- 状态标签
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(0.9, 0, 0.2, 0)
StatusLabel.Position = UDim2.new(0.05, 0, 0.75, 0)
StatusLabel.Text = "状态: 就绪"
StatusLabel.TextColor3 = Color3.fromRGB(220, 220, 220)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 12
StatusLabel.Parent = ButtonContainer

-- 添加按钮圆角
local ButtonCorner = Instance.new("UICorner")
ButtonCorner.CornerRadius = UDim.new(0, 6)
ButtonCorner.Parent = TeleportButton

local StopButtonCorner = Instance.new("UICorner")
StopButtonCorner.CornerRadius = UDim.new(0, 6)
StopButtonCorner.Parent = StopButton

-- 按钮悬停效果
TeleportButton.MouseEnter:Connect(function()
    if not isTeleporting then
        game:GetService("TweenService"):Create(TeleportButton, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(0, 150, 255)}):Play()
    end
end)

TeleportButton.MouseLeave:Connect(function()
    if not isTeleporting then
        game:GetService("TweenService"):Create(TeleportButton, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(0, 120, 215)}):Play()
    end
end)

StopButton.MouseEnter:Connect(function()
    game:GetService("TweenService"):Create(StopButton, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(255, 80, 0)}):Play()
end)

StopButton.MouseLeave:Connect(function()
    game:GetService("TweenService"):Create(StopButton, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(215, 60, 0)}):Play()
end)

-- 停止传送函数
local function stopTeleportation()
    if isTeleporting then
        isTeleporting = false
        StatusLabel.Text = "状态: 正在停止..."
        
        -- 如果有正在运行的任务，停止它
        if currentTeleportTask then
            coroutine.close(currentTeleportTask)
            currentTeleportTask = nil
        end
        
        -- 重置按钮状态
        TeleportButton.Text = "开始传送到所有僵尸"
        TeleportButton.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
        StopButton.Visible = false
        StatusLabel.Text = "状态: 已停止"
        
        print("传送已停止")
        
        -- 2秒后恢复"就绪"状态
        wait(2)
        StatusLabel.Text = "状态: 就绪"
    end
end

-- 传送函数
local function teleportToAllZombies()
    -- 检查是否已经在传送
    if isTeleporting then
        return
    end
    
    -- 检查路径是否存在
    if not Workspace:FindFirstChild("game") then
        warn("未找到 'game' 文件夹")
        StatusLabel.Text = "状态: 错误 - 找不到game文件夹"
        return
    end
    
    local gameFolder = Workspace.game
    
    if not gameFolder:FindFirstChild("map") then
        warn("未找到 'map' 文件夹")
        StatusLabel.Text = "状态: 错误 - 找不到map文件夹"
        return
    end
    
    local mapFolder = gameFolder.map
    
    if not mapFolder:FindFirstChild("zombies") then
        warn("未找到 'zombies' 文件夹")
        StatusLabel.Text = "状态: 错误 - 找不到zombies文件夹"
        return
    end
    
    local zombiesFolder = mapFolder.zombies
    
    -- 获取所有僵尸模型
    local zombieModels = {}
    for _, child in pairs(zombiesFolder:GetChildren()) do
        if child:IsA("Model") then
            table.insert(zombieModels, child)
        end
    end
    
    if #zombieModels == 0 then
        warn("没有找到僵尸模型")
        StatusLabel.Text = "状态: 错误 - 没有找到僵尸"
        return
    end
    
    print("找到 " .. #zombieModels .. " 个僵尸")
    
    -- 开始传送
    isTeleporting = true
    TeleportButton.Text = "传送中..."
    TeleportButton.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
    StopButton.Visible = true
    StatusLabel.Text = "状态: 传送中 (0/" .. #zombieModels .. ")"
    
    -- 在协程中执行传送，以便可以随时停止
    currentTeleportTask = coroutine.create(function()
        -- 依次传送到每个僵尸
        for i, zombie in ipairs(zombieModels) do
            -- 检查是否被停止
            if not isTeleporting then
                break
            end
            
            -- 检查玩家角色
            if not Character or not Character:FindFirstChild("HumanoidRootPart") then
                Character = LocalPlayer.Character
                if Character then
                    HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
                else
                    warn("角色不存在")
                    break
                end
            end
            
            -- 更新状态
            StatusLabel.Text = "状态: 传送中 (" .. i .. "/" .. #zombieModels .. ")"
            
            -- 寻找僵尸的头部
            local head = zombie:FindFirstChild("Head")
            local humanoidRootPart = zombie:FindFirstChild("HumanoidRootPart") or zombie:FindFirstChild("Torso")
            
            if head or humanoidRootPart then
                local targetPart = head or humanoidRootPart
                
                -- 计算传送位置（传送到目标正上方更高的位置）
                local teleportPosition
                
                -- 使用模型高度或基础高度
                if zombie:GetExtentsSize().Y > 0 then
                    local modelHeight = zombie:GetExtentsSize().Y
                    teleportPosition = targetPart.Position + Vector3.new(0, modelHeight + baseHeight, 0)
                else
                    teleportPosition = targetPart.Position + Vector3.new(0, baseHeight, 0)
                end
                
                -- 执行传送
                HumanoidRootPart.CFrame = CFrame.new(teleportPosition)
                
                print("已传送到僵尸 #" .. i .. " (" .. zombie.Name .. ")")
                
                -- 等待1秒后传送到下一个
                for waitTime = 1, 0, -0.1 do
                    if not isTeleporting then
                        break
                    end
                    wait(0.1)
                end
                
            else
                warn("僵尸 " .. zombie.Name .. " 没有找到头部或躯干")
                -- 如果找不到头部，使用模型的位置
                local teleportPosition = zombie:GetPivot().Position + Vector3.new(0, baseHeight, 0)
                HumanoidRootPart.CFrame = CFrame.new(teleportPosition)
                
                -- 等待1秒
                for waitTime = 1, 0, -0.1 do
                    if not isTeleporting then
                        break
                    end
                    wait(0.1)
                end
            end
        end
        
        -- 传送完成或停止后的处理
        if isTeleporting then
            -- 自然完成
            StatusLabel.Text = "状态: 传送完成!"
            TeleportButton.Text = "开始传送到所有僵尸"
            TeleportButton.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
            StopButton.Visible = false
            print("传送完成！")
            
            -- 3秒后恢复"就绪"状态
            wait(3)
            StatusLabel.Text = "状态: 就绪"
        end
        
        isTeleporting = false
        currentTeleportTask = nil
    end)
    
    -- 启动协程
    coroutine.resume(currentTeleportTask)
end

-- 按钮点击事件
TeleportButton.MouseButton1Click:Connect(function()
    if not isTeleporting then
        teleportToAllZombies()
    end
end)

StopButton.MouseButton1Click:Connect(function()
    stopTeleportation()
end)

-- 可选：添加键盘快捷键
local UserInputService = game:GetService("UserInputService")
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if input.KeyCode == Enum.KeyCode.T and not gameProcessed and not isTeleporting then
        teleportToAllZombies()
    elseif input.KeyCode == Enum.KeyCode.Y and not gameProcessed and isTeleporting then
        stopTeleportation()
    end
end)

-- 添加高度调节滑块
local heightSliderGui = Instance.new("ScreenGui")
heightSliderGui.Parent = game.CoreGui

local heightFrame = Instance.new("Frame")
heightFrame.Size = UDim2.new(0, 210, 0, 80)
heightFrame.Position = UDim2.new(0.5, -105, 0, 150)
heightFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
heightFrame.BackgroundTransparency = 0.3
heightFrame.Parent = heightSliderGui

local heightLabel = Instance.new("TextLabel")
heightLabel.Size = UDim2.new(1, 0, 0.4, 0)
heightLabel.Text = "传送高度: " .. baseHeight .. " studs"
heightLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
heightLabel.BackgroundTransparency = 1
heightLabel.Parent = heightFrame

local heightSlider = Instance.new("TextButton")
heightSlider.Size = UDim2.new(0.9, 0, 0.3, 0)
heightSlider.Position = UDim2.new(0.05, 0, 0.5, 0)
heightSlider.Text = ""
heightSlider.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
heightSlider.Parent = heightFrame

local heightFill = Instance.new("Frame")
heightFill.Size = UDim2.new(0.3, 0, 1, 0)  -- 初始30%（对应15 studs）
heightFill.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
heightFill.Parent = heightSlider

local UICorner2 = Instance.new("UICorner")
UICorner2.CornerRadius = UDim.new(0, 4)
UICorner2.Parent = heightSlider

local UICorner3 = Instance.new("UICorner")
UICorner3.CornerRadius = UDim.new(0, 8)
UICorner3.Parent = heightFrame

-- 滑块交互
heightSlider.MouseButton1Down:Connect(function()
    local connection
    connection = game:GetService("RunService").RenderStepped:Connect(function()
        local mouse = game:GetService("Players").LocalPlayer:GetMouse()
        local x = mouse.X - heightSlider.AbsolutePosition.X
        local width = heightSlider.AbsoluteSize.X
        local percentage = math.clamp(x / width, 0, 1)
        
        heightFill.Size = UDim2.new(percentage, 0, 1, 0)
        
        -- 高度范围：5到50 studs
        baseHeight = math.floor(5 + percentage * 45)
        heightLabel.Text = "传送高度: " .. baseHeight .. " studs"
    end)
    
    game:GetService("UserInputService").InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            connection:Disconnect()
        end
    end)
end)

print("脚本加载成功！")
print("快捷键: T - 开始传送, Y - 停止传送")
print("使用滑块调整传送高度 (5-50 studs)")
