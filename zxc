-- Roblox 物品透视脚本
-- 显示 workspace.game.map.items 中的所有物品并添加名称标签

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

local localPlayer = Players.LocalPlayer
if not localPlayer then
    Players:GetPropertyChangedSignal("LocalPlayer"):Wait()
    localPlayer = Players.LocalPlayer
end

local itemsFolder = workspace:FindFirstChild("game") and workspace.game:FindFirstChild("map") and workspace.game.map:FindFirstChild("items")

if not itemsFolder then
    warn("无法找到 items 文件夹，请检查路径：workspace.game.map.items")
    return
end

-- 存储所有创建的标签
local itemLabels = {}
local enabled = true

-- 创建透视标签
local function createLabel(item)
    if not item:IsA("BasePart") and not item:IsA("Model") then
        return
    end
    
    local name = item.Name
    local primaryPart = nil
    
    if item:IsA("Model") then
        primaryPart = item.PrimaryPart or item:FindFirstChildWhichIsA("BasePart")
    else
        primaryPart = item
    end
    
    if not primaryPart then
        return
    end
    
    -- 创建BillboardGui（屏幕空间标签）
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ItemLabel_" .. name
    billboard.Adornee = primaryPart
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.MaxDistance = 1000
    billboard.Enabled = enabled
    
    -- 创建背景框
    local frame = Instance.new("Frame")
    frame.Name = "Background"
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    frame.BackgroundTransparency = 0.5
    frame.BorderSizePixel = 0
    
    -- 创建物品名称文本
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "ItemName"
    nameLabel.Size = UDim2.new(1, 0, 0.7, 0)
    nameLabel.Position = UDim2.new(0, 0, 0, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = name
    nameLabel.TextColor3 = Color3.fromRGB(255, 255, 0) -- 黄色
    nameLabel.TextScaled = true
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.TextStrokeTransparency = 0.5
    
    -- 创建距离文本
    local distanceLabel = Instance.new("TextLabel")
    distanceLabel.Name = "Distance"
    distanceLabel.Size = UDim2.new(1, 0, 0.3, 0)
    distanceLabel.Position = UDim2.new(0, 0, 0.7, 0)
    distanceLabel.BackgroundTransparency = 1
    distanceLabel.TextColor3 = Color3.fromRGB(200, 200, 200) -- 浅灰色
    distanceLabel.TextScaled = true
    distanceLabel.Font = Enum.Font.Gotham
    
    -- 组装标签
    frame.Parent = billboard
    nameLabel.Parent = frame
    distanceLabel.Parent = frame
    
    -- 将标签添加到ScreenGui
    local screenGui = CoreGui:FindFirstChild("ItemESP") or Instance.new("ScreenGui")
    screenGui.Name = "ItemESP"
    screenGui.Parent = CoreGui
    
    billboard.Parent = screenGui
    
    -- 存储引用
    itemLabels[item] = {
        billboard = billboard,
        primaryPart = primaryPart,
        nameLabel = nameLabel,
        distanceLabel = distanceLabel
    }
    
    -- 添加高亮效果（可选）
    local highlight = Instance.new("Highlight")
    highlight.Name = "ItemHighlight"
    highlight.FillColor = Color3.fromRGB(255, 255, 0) -- 黄色
    highlight.FillTransparency = 0.7
    highlight.OutlineColor = Color3.fromRGB(255, 200, 0)
    highlight.OutlineTransparency = 0
    highlight.Enabled = enabled
    highlight.Parent = item
    
    return itemLabels[item]
end

-- 更新标签位置和距离
local function updateLabels()
    if not enabled then return end
    
    local character = localPlayer.Character
    local playerRoot = character and character:FindFirstChild("HumanoidRootPart")
    
    for item, labelData in pairs(itemLabels) do
        if labelData.billboard and labelData.billboard.Parent and labelData.primaryPart and labelData.primaryPart.Parent then
            -- 更新距离
            if playerRoot then
                local distance = (playerRoot.Position - labelData.primaryPart.Position).Magnitude
                labelData.distanceLabel.Text = string.format("%.1f 米", distance)
                
                -- 根据距离调整颜色
                if distance < 10 then
                    labelData.nameLabel.TextColor3 = Color3.fromRGB(0, 255, 0) -- 绿色（近）
                elseif distance < 30 then
                    labelData.nameLabel.TextColor3 = Color3.fromRGB(255, 255, 0) -- 黄色（中）
                else
                    labelData.nameLabel.TextColor3 = Color3.fromRGB(255, 100, 100) -- 红色（远）
                end
            end
        else
            -- 清理无效标签
            if labelData.billboard then
                labelData.billboard:Destroy()
            end
            itemLabels[item] = nil
        end
    end
end

-- 扫描并创建所有物品标签
local function scanItems()
    for _, item in pairs(itemsFolder:GetChildren()) do
        if not itemLabels[item] then
            createLabel(item)
        end
    end
    
    -- 检查是否有物品被移除
    for item, labelData in pairs(itemLabels) do
        if not item.Parent or item.Parent ~= itemsFolder then
            if labelData.billboard then
                labelData.billboard:Destroy()
            end
            itemLabels[item] = nil
        end
    end
end

-- 监听新物品
itemsFolder.ChildAdded:Connect(function(child)
    task.wait(0.5) -- 等待物品完全加载
    if enabled then
        createLabel(child)
    end
end)

-- 监听物品移除
itemsFolder.ChildRemoved:Connect(function(child)
    if itemLabels[child] then
        if itemLabels[child].billboard then
            itemLabels[child].billboard:Destroy()
        end
        itemLabels[child] = nil
    end
end)

-- 创建GUI控制界面
local function createControlGUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "ItemESPControls"
    
    local frame = Instance.new("Frame")
    frame.Name = "ControlPanel"
    frame.Size = UDim2.new(0, 200, 0, 100)
    frame.Position = UDim2.new(0, 10, 0, 10)
    frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    frame.BackgroundTransparency = 0.3
    frame.BorderSizePixel = 0
    
    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(1, 0, 0, 30)
    title.Position = UDim2.new(0, 0, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = "物品透视控制"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Font = Enum.Font.GothamBold
    
    local toggleButton = Instance.new("TextButton")
    toggleButton.Name = "ToggleButton"
    toggleButton.Size = UDim2.new(0.8, 0, 0, 40)
    toggleButton.Position = UDim2.new(0.1, 0, 0.4, 0)
    toggleButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    toggleButton.Text = "关闭透视"
    toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    toggleButton.Font = Enum.Font.Gotham
    
    toggleButton.MouseButton1Click:Connect(function()
        enabled = not enabled
        
        -- 切换所有标签和高亮
        for item, labelData in pairs(itemLabels) do
            if labelData.billboard then
                labelData.billboard.Enabled = enabled
            end
            local highlight = item:FindFirstChild("ItemHighlight")
            if highlight then
                highlight.Enabled = enabled
            end
        end
        
        toggleButton.Text = enabled and "关闭透视" or "开启透视"
        toggleButton.BackgroundColor3 = enabled and Color3.fromRGB(60, 60, 60) or Color3.fromRGB(100, 60, 60)
    end)
    
    -- 组装控制面板
    title.Parent = frame
    toggleButton.Parent = frame
    frame.Parent = screenGui
    screenGui.Parent = CoreGui
end

-- 初始化
task.wait(1) -- 等待游戏加载
scanItems()
createControlGUI()

-- 主循环
RunService.RenderStepped:Connect(function()
    if enabled then
        updateLabels()
    end
end)

-- 自动重新扫描（每10秒一次）
while task.wait(10) do
    if enabled then
        scanItems()
    end
end
